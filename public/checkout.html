<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ø£ÙƒÙ…Ù„ Ø·Ù„Ø¨Ùƒ - Ø£Ø¯Ø®Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨">
    <meta name="theme-color" content="#f97316">
    <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ - Ù…Ø·Ø¹Ù…ÙŠ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span class="logo-icon rocket-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="currentColor">
                           <path class="rocket-body" d="M12 2.5s-6 6.5-6 11c0 3 2.5 5.5 6 5.5s6-2.5 6-5.5c0-4.5-6-11-6-11z" fill="#E0E0E0"/>
                           <path class="rocket-window" d="M12 9a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5z" fill="#3B82F6"/>
                           <path class="rocket-fins" d="M5.5 14L2 19h5l1-2.5M18.5 14L22 19h-5l-1-2.5" fill="#FF5722"/>
                           <path class="rocket-fire" d="M12 20s-1.5 1.5-1.5 3 .5 1 1.5 1 1.5.5 1.5-1-1.5-3-1.5-3z" fill="#FFC107"/>
                        </svg>
                    </span>
                    <span id="logoName"></span>
                </a>
                
                <div class="header-actions">
                    <a href="cart.html" class="btn btn-secondary">
                        â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø³Ù„Ø©
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Checkout Page -->
    <main class="cart-page">
        <div class="container">
            <h1 class="fade-in" style="margin-bottom: 2rem;">ğŸ“ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</h1>
            
            <div class="checkout-grid">
                <!-- Checkout Form -->
                <div>
                    <form id="checkoutForm" onsubmit="handleCheckout(event)">
                        <!-- Customer Info -->
                        <div class="checkout-section fade-in fade-in-delay-1">
                            <h3 class="section-title">ğŸ‘¤ Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ</h3>
                            
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                                <input type="text" class="form-input" id="customerName" required 
                                       placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                                <input type="tel" class="form-input" id="customerPhone" required 
                                       placeholder="05XX XXX XXX" pattern="0[5-7][0-9]{8}"
                                       style="direction: ltr; text-align: right;">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ø¨Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</small>
                            </div>
                        </div>
                        
                        <!-- Order Type -->
                        <div class="checkout-section fade-in fade-in-delay-2">
                            <h3 class="section-title">ğŸš€ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</h3>
                            
                            <div class="radio-cards">
                                <label class="radio-card selected" id="deliveryCard">
                                    <input type="radio" name="orderType" value="delivery" checked 
                                           onchange="toggleOrderType('delivery')">
                                    <div class="radio-card-icon">ğŸ›µ</div>
                                    <div class="radio-card-title">ØªÙˆØµÙŠÙ„</div>
                                    <div class="radio-card-desc">Ù†ÙˆØµÙ„Ùƒ Ù„Ù„Ø¨Ø§Ø¨</div>
                                </label>
                                
                                <label class="radio-card" id="dineInCard">
                                    <input type="radio" name="orderType" value="dineIn" 
                                           onchange="toggleOrderType('dineIn')">
                                    <div class="radio-card-icon">ğŸ½ï¸</div>
                                    <div class="radio-card-title">Ø­Ø¶ÙˆØ±</div>
                                    <div class="radio-card-desc">ØªØ£ÙƒÙ„ Ø¹Ù†Ø¯Ù†Ø§</div>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Delivery Address -->
                        <div id="addressSection" class="checkout-section fade-in fade-in-delay-2">
                            <h3 class="section-title">ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙˆØµÙŠÙ„</h3>
                            
                            <!-- Location Search -->
                            <div class="form-group" style="position: relative; z-index: 1000;">
                                <label class="form-label">ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆÙ‚Ø¹</label>
                                <div style="position: relative;">
                                    <input type="text" class="form-input" id="locationSearch" 
                                           placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ø·Ø© Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ù…Ø­Ù…Ø¯ÙŠØ©ØŒ Ù…Ø³Ø¬Ø¯ØŒ Ù…Ø·Ø¹Ù…..."
                                           autocomplete="off">
                                    <div id="searchResults" class="search-results-dropdown"></div>
                                </div>
                            </div>
                            
                                <!-- Map Container -->
                                <div class="map-wrapper" style="position: relative;">
                                    <div id="mapLoader" class="map-loading-overlay">
                                        <div class="spinner"></div>
                                        <span style="margin-top: 10px; font-weight: 600;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©...</span>
                                    </div>
                                    <div id="mapContainer" class="map-container"></div>
                                </div>
                            
                            <!-- Location Buttons -->
                            <div style="display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" onclick="getMyLocation()">
                                    ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearLocation()">
                                    ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                                </button>
                            </div>
                            
                            <!-- Selected Location Display -->
                            <div id="selectedLocation" class="selected-location-card">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <strong style="color: var(--accent);">âœ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯:</strong>
                                    <span style="font-size: 0.8rem; background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 4px;">âš ï¸ ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¯Ù‚ÙŠÙ‚</span>
                                </div>
                                <p id="selectedLocationText" style="margin: 0.5rem 0 0; color: var(--text-secondary);"></p>
                            </div>
                            
                            <!-- Manual Address -->
                            <div class="form-group">
                                <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <textarea class="form-textarea" id="address" 
                                          placeholder="Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ø§Ø±Ø©ØŒ Ø§Ù„Ø·Ø§Ø¨Ù‚ØŒ Ø¹Ù„Ø§Ù…Ø© Ù…Ù…ÙŠØ²Ø©..."></textarea>
                            </div>
                            
                            <input type="hidden" id="locationLat">
                            <input type="hidden" id="locationLng">
                            <input type="hidden" id="locationName">
                        </div>
                        
                        <!-- Scheduled Time -->

                        
                        <!-- Notes -->
                        <div class="checkout-section fade-in fade-in-delay-3">
                            <h3 class="section-title">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</h3>
                            
                            <div class="form-group" style="margin-bottom: 0;">
                                <textarea class="form-textarea" id="notes" rows="3"
                                          placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ù„Ø¨..."></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg btn-block fade-in fade-in-delay-3">
                            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ âœ“
                        </button>
                    </form>
                </div>
                
                <!-- Order Summary -->
                <div>
                    <div class="cart-summary fade-in fade-in-delay-2">
                        <h3 style="margin-bottom: 1.5rem;">ğŸ§¾ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h3>
                        
                        <div id="checkoutItems" style="margin-bottom: 1.5rem;">
                            <!-- Items will be loaded here -->
                        </div>
                        
                        <div class="summary-row">
                            <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span>
                            <span id="checkoutSubtotal">0 Ø¯Ø¬</span>
                        </div>
                        <div class="summary-row" id="deliveryRow">
                            <span>Ø§Ù„ØªÙˆØµÙŠÙ„</span>
                            <span id="checkoutDelivery">0 Ø¯Ø¬</span>
                        </div>
                        <div class="summary-row">
                            <span style="font-weight: 700; font-size: 1.1rem;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                            <span class="summary-total" id="checkoutTotal">0 Ø¯Ø¬</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/api-client.js"></script>
    <script src="js/data.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/orders.js"></script>
    <script>
        // Map variables
        let map = null;
        let marker = null;
        let searchTimeout = null;
        let userLocation = null;
        
        // Default location (Algeria - Algiers)
        const defaultLat = 36.7538;
        const defaultLng = 3.0588;
        
        document.addEventListener('DOMContentLoaded', async () => {
            const cart = getCart();
            if (cart.length === 0) {
                window.location.href = 'cart.html';
                return;
            }
            
            // Wait for settings to load
            if (typeof initializeData === 'function') {
                await initializeData();
            }

            // Load Header Name
            const settings = getSettings();
            if (settings.restaurantName) {
                const logoName = document.getElementById('logoName');
                if (logoName) logoName.textContent = settings.restaurantName;
            }

            renderCheckoutItems();
            updateCheckoutSummary();
            
            // Artificial delay for professional feel + valid map resizing
            setTimeout(() => {
                initMap();
                const loader = document.getElementById('mapLoader');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 300);
                }
            }, 1000);

            setupLocationSearch();
            
            // Listen for any latent updates
            document.addEventListener('data-ready', () => {
                const settings = getSettings();
                if (settings.restaurantName) {
                    const logoName = document.getElementById('logoName');
                    if (logoName) logoName.textContent = settings.restaurantName;
                }
                updateCheckoutSummary();
            });
        });
        
        function initMap() {
            // Start map at default location
            map = L.map('mapContainer').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            map.on('click', function(e) {
                setMapLocation(e.latlng.lat, e.latlng.lng);
                reverseGeocode(e.latlng.lat, e.latlng.lng);
            });
            
            // Show toast instruction
            showToast('Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø©', 'info');
        }

        function setupLocationSearch() {
            const searchInput = document.getElementById('locationSearch');
            const resultsContainer = document.getElementById('searchResults');
            
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => searchPlaces(query), 400);
            });
            
            searchInput.addEventListener('blur', () => {
                setTimeout(() => resultsContainer.style.display = 'none', 300);
            });
            
            searchInput.addEventListener('focus', () => {
                if (resultsContainer.innerHTML) {
                    resultsContainer.style.display = 'block';
                }
            });
        }
        
        async function searchPlaces(query) {
            const resultsContainer = document.getElementById('searchResults');
            
            resultsContainer.innerHTML = '<div class="search-loading">ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';
            resultsContainer.style.display = 'block';
            
            try {
                const lat = userLocation?.lat || defaultLat;
                const lng = userLocation?.lng || defaultLng;
                const delta = 0.2;
                const viewbox = `${lng - delta},${lat + delta},${lng + delta},${lat - delta}`;
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=dz&limit=10&addressdetails=1&viewbox=${viewbox}&bounded=0`,
                    { headers: { 'Accept-Language': 'ar' } }
                );
                const results = await response.json();
                
                if (results.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="search-empty">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”</div>
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù‚Ø±ÙŠØ¨Ø©
                            <br><small>Ø¬Ø±Ø¨ ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</small>
                        </div>
                    `;
                } else {
                    if (userLocation) {
                        results.sort((a, b) => {
                            const distA = getDistance(userLocation.lat, userLocation.lng, parseFloat(a.lat), parseFloat(a.lon));
                            const distB = getDistance(userLocation.lat, userLocation.lng, parseFloat(b.lat), parseFloat(b.lon));
                            return distA - distB;
                        });
                    }
                    
                    resultsContainer.innerHTML = results.map(place => {
                        const distance = userLocation 
                            ? getDistance(userLocation.lat, userLocation.lng, parseFloat(place.lat), parseFloat(place.lon))
                            : null;
                        const distanceText = distance !== null 
                            ? (distance < 1 ? `${Math.round(distance * 1000)} Ù…` : `${distance.toFixed(1)} ÙƒÙ…`)
                            : '';
                            
                        return `
                            <div class="search-result-item" onclick="selectPlace(${place.lat}, ${place.lon}, '${escapeHtml(place.display_name)}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: 600;">ğŸ“ ${getPlaceType(place)}</div>
                                    ${distanceText ? `<div class="distance-badge">â†” ${distanceText}</div>` : ''}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">${place.display_name}</div>
                            </div>
                        `;
                    }).join('');
                }
                
                resultsContainer.style.display = 'block';
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div class="search-error">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</div>';
                resultsContainer.style.display = 'block';
            }
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function getPlaceType(place) {
            if (place.type) {
                const types = {
                    'fuel': 'Ù…Ø­Ø·Ø© ÙˆÙ‚ÙˆØ¯',
                    'restaurant': 'Ù…Ø·Ø¹Ù…',
                    'cafe': 'Ù…Ù‚Ù‡Ù‰',
                    'mosque': 'Ù…Ø³Ø¬Ø¯',
                    'hospital': 'Ù…Ø³ØªØ´ÙÙ‰',
                    'pharmacy': 'ØµÙŠØ¯Ù„ÙŠØ©',
                    'school': 'Ù…Ø¯Ø±Ø³Ø©',
                    'supermarket': 'Ø³ÙˆØ¨Ø±Ù…Ø§Ø±ÙƒØª',
                    'bank': 'Ø¨Ù†Ùƒ',
                    'hotel': 'ÙÙ†Ø¯Ù‚'
                };
                if (types[place.type]) return types[place.type];
            }
            return place.name || 'Ù…ÙˆÙ‚Ø¹';
        }
        
        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        function selectPlace(lat, lng, displayName) {
            document.getElementById('locationSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            setMapLocation(lat, lng);
            setLocationDisplay(displayName);
            
            const shortName = displayName.split(',').slice(0, 3).join('ØŒ');
            if (!document.getElementById('address').value) {
                document.getElementById('address').value = shortName;
            }
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`,
                    { headers: { 'Accept-Language': 'ar' } }
                );
                const result = await response.json();
                
                if (result.display_name) {
                    setLocationDisplay(result.display_name);
                }
            } catch (error) {
                console.error('Reverse geocode error:', error);
            }
        }
        
        function setLocationDisplay(text) {
            document.getElementById('locationName').value = text;
            document.getElementById('selectedLocationText').textContent = text;
            document.getElementById('selectedLocation').style.display = 'block';
        }

        function setMapLocation(lat, lng) {
            document.getElementById('locationLat').value = lat;
            document.getElementById('locationLng').value = lng;
            userLocation = { lat, lng };
            
            if (marker) {
                marker.setLatLng([lat, lng]);
            } else {
                const userIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                marker = L.marker([lat, lng], { draggable: true, icon: userIcon }).addTo(map);
                marker.bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹Ùƒ").openPopup();
                
                marker.on('dragend', function(e) {
                    const pos = marker.getLatLng();
                    setMapLocation(pos.lat, pos.lng); // Recursive but safe as it updates values
                    reverseGeocode(pos.lat, pos.lng);
                });
            }
            
            map.setView([lat, lng], 16);
            updateCheckoutSummary(); // Will update delivery cost based on distance
        }
        
        // Helper to remove routing artifacts if any exist
        function clearRoute() {
            // No-op since routing is removed
        }

        function clearLocation() {
            document.getElementById('locationLat').value = '';
            document.getElementById('locationLng').value = '';
            document.getElementById('locationName').value = '';
            document.getElementById('selectedLocation').style.display = 'none';
            
            if (marker) {
                map.removeLayer(marker);
                marker = null;
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
                accuracyCircle = null;
            }
            
            map.setView([defaultLat, defaultLng], 13);
            showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹', 'info');
        }
        
        let accuracyCircle = null;

        async function getMyLocation() {
            const btn = document.querySelector('button[onclick="getMyLocation()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (GPS)...';
            btn.disabled = true;
            
            try {
                const location = await getCurrentLocation();
                setMapLocation(location.lat, location.lng);
                reverseGeocode(location.lat, location.lng);
                
                // Accuracy Feedback
                const acc = Math.round(location.accuracy);
                
                // Show circle on map
                if (accuracyCircle) map.removeLayer(accuracyCircle);
                accuracyCircle = L.circle([location.lat, location.lng], {
                    radius: location.accuracy,
                    color: acc <= 30 ? '#10b981' : '#f59e0b',
                    fillColor: acc <= 30 ? '#10b981' : '#f59e0b',
                    fillOpacity: 0.15,
                    weight: 1
                }).addTo(map);
                
                if (acc <= 30) {
                    showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø© Ù…Ù…ØªØ§Ø²Ø© (${acc} Ù…ØªØ±)`, 'success');
                } else if (acc <= 100) {
                    showToast(`Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…ØªÙˆØ³Ø·Ø© (${acc} Ù…ØªØ±). ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS ÙÙŠ Ù…ÙƒØ§Ù† Ù…ÙØªÙˆØ­`, 'warning');
                } else {
                    showToast(`Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù†Ø®ÙØ¶Ø© (${acc} Ù…ØªØ±). Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªÙØ¹ÙŠÙ„ GPS ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹ÙˆØ§Ø¦Ù‚`, 'error');
                }
                
                // Zoom to fit accuracy circle if it's large, otherwise standard zoom
                if (acc > 50) {
                    map.fitBounds(accuracyCircle.getBounds());
                }

            } catch (error) {
                showToast(error.message, 'error');
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
        
        function renderCheckoutItems() {
            const container = document.getElementById('checkoutItems');
            const cart = getCart();
            
            container.innerHTML = cart.map(item => `
                <div class="checkout-item">
                    <div>
                        <span style="font-weight: 600;">${item.name}</span>
                        ${item.sizeName ? `<span style="color: var(--text-muted);"> (${item.sizeName})</span>` : ''}
                        <span style="color: var(--text-muted);"> Ã— ${item.quantity}</span>
                    </div>
                    <div style="font-weight: 600;">${formatPrice(item.price * item.quantity)}</div>
                </div>
            `).join('');
        }
        
        function updateCheckoutSummary() {
            const subtotal = getCartTotal();
            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            const settings = getSettings();
            
            document.getElementById('checkoutSubtotal').textContent = formatPrice(subtotal);
            
            let deliveryText = 'Ù…Ø¬Ø§Ù†ÙŠ';
            let total = subtotal;
            
            if (orderType === 'delivery' && settings.delivery?.enabled) {
                if (settings.delivery.type === 'fixed') {
                    const cost = settings.delivery.fixedCost || 0;
                    deliveryText = formatPrice(cost);
                    total += cost;
                } else if (settings.delivery.type === 'distance') {
                    if (settings.location && settings.location.lat && document.getElementById('locationLat').value) {
                         // Calculate distance
                         const userLat = parseFloat(document.getElementById('locationLat').value);
                         const userLng = parseFloat(document.getElementById('locationLng').value);
                         const dist = getDistance(userLat, userLng, settings.location.lat, settings.location.lng);
                         
                         // Check max distance
                         if (settings.delivery.maxDistance && dist > settings.delivery.maxDistance) {
                             deliveryText = 'Ø®Ø§Ø±Ø¬ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙˆØµÙŠÙ„';
                             document.getElementById('checkoutTotal').style.color = 'var(--danger)';
                         } else {
                             const cost = Math.ceil(dist * (settings.delivery.costPerKm || 50));
                             deliveryText = formatPrice(cost);
                             total += cost;
                             document.getElementById('checkoutTotal').style.color = '';
                         }
                    } else {
                        deliveryText = 'ÙŠÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹';
                    }
                } else if (settings.delivery.type === 'free') {
                    deliveryText = 'Ù…Ø¬Ø§Ù†ÙŠ';
                } else if (settings.delivery.type === 'not_specified') {
                    deliveryText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                } else {
                    deliveryText = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                }
            } else {
                 deliveryText = 'Ù…Ø¬Ø§Ù†ÙŠ';
            }
            
            document.getElementById('checkoutDelivery').textContent = deliveryText;
            
            // If total assumes delivery cost is known add it, otherwise just subtotal or show suffix
            if (deliveryText === 'ÙŠÙØ­Ø³Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©' || deliveryText === 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') {
                 document.getElementById('checkoutTotal').textContent = formatPrice(subtotal) + ' + Ø§Ù„ØªÙˆØµÙŠÙ„';
            } else {
                 document.getElementById('checkoutTotal').textContent = formatPrice(total);
            }
            
            document.getElementById('deliveryRow').style.display = orderType === 'delivery' ? 'flex' : 'none';
        }
        
        function toggleOrderType(type) {
            document.querySelectorAll('.radio-card').forEach(card => {
                if (card.id === 'deliveryCard' || card.id === 'dineInCard') {
                    card.classList.remove('selected');
                }
            });
            
            if (type === 'delivery') {
                document.getElementById('deliveryCard').classList.add('selected');
                document.getElementById('addressSection').style.display = 'block';
                document.getElementById('address').required = false; // Optional
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            } else {
                document.getElementById('dineInCard').classList.add('selected');
                document.getElementById('addressSection').style.display = 'none';
                document.getElementById('address').required = false;
            }
            
            updateCheckoutSummary();
        }
        

        
        async function handleCheckout(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const orderType = document.querySelector('input[name="orderType"]:checked').value;
            const address = document.getElementById('address').value.trim();
            const notes = document.getElementById('notes').value.trim();
            
            if (!validatePhone(customerPhone)) {
                showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 Ø£Ùˆ 06 Ø£Ùˆ 07', 'error');
                return;
            }
            
            if (orderType === 'delivery') {
                const locationLat = document.getElementById('locationLat').value;
                if (!locationLat) {
                    showToast('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨', 'error');
                    return;
                }
            }
            
            showLoading(true);
            
            const orderData = {
                customerName,
                customerPhone,
                orderType,
                address: orderType === 'delivery' ? address : '',
                location: document.getElementById('locationLat').value ? {
                    lat: parseFloat(document.getElementById('locationLat').value),
                    lng: parseFloat(document.getElementById('locationLng').value)
                } : null,
                scheduledTime: null,
                notes
            };
            
            const order = await createOrder(orderData);
            
            showLoading(false);
            
            if (order) {
                sessionStorage.setItem('lastOrderNumber', order.orderNumber);
                sessionStorage.setItem('lastOrderId', order.id);
                window.location.href = 'order-success.html';
            } else {
                showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', 'error');
            }
        }
    </script>
    
    <style>
        .checkout-grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 2rem;
        }
        
        .checkout-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }
        
        .map-container {
            height: 320px;
            border-radius: var(--radius-lg);
            margin-bottom: 1.25rem;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        
        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            max-height: 280px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-xl);
        }
        
        .search-result-item {
            padding: 0.85rem 1.25rem;
            cursor: pointer;
            border-bottom: 1px solid var(--glass-border);
            transition: background 0.2s ease;
        }
        
        .search-result-item:hover {
            background: var(--glass-hover);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .distance-badge {
            font-size: 0.8rem;
            color: var(--primary-light);
            font-weight: 600;
        }
        
        .search-loading,
        .search-empty,
        .search-error {
            padding: 1.25rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .search-error {
            color: var(--danger);
        }
        
        .selected-location-card {
            display: none;
            padding: 1rem 1.25rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: var(--radius-lg);
            margin-bottom: 1.25rem;
            border: 1px solid var(--accent);
        }
        
        .checkout-item {
            display: flex;
            justify-content: space-between;
            padding: 0.85rem 0;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .checkout-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 900px) {
            .checkout-grid {
                grid-template-columns: 1fr;
            }
            .cart-summary {
                position: static !important;
            }
        }
        .map-loading-overlay {
            position: absolute;
            inset: 0;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: opacity 0.3s ease;
        }
    </style>
</body>
</html>
