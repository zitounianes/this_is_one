// =====================================================
// إدارة الطلبات - Orders Management
// =====================================================

// إنشاء طلب جديد
async function createOrder(orderData) {
    // التحقق من حالة المطعم
    const settings = getSettings();
    if (settings && settings.isOpen === false) {
        showToast('عذراً، المطعم مغلق حالياً', 'error');
        return null; // Should handle async/null in caller
    }

    const cart = getCart();
    
    if (cart.length === 0) {
        showToast('السلة فارغة', 'error');
        return null;
    }
    
    const subtotal = getCartTotal();
    const deliveryCost = orderData.orderType === 'delivery' 
        ? calculateDeliveryCost(subtotal, orderData.distance || 0) 
        : 0;
    
    // Construct Order Object for API
    const orderPayload = {
        // id will be generated by DB
        // orderNumber will be generated by data.js or backend? 
        // Backend seed uses simple Int ID, but data.js used to generate string IDs.
        // Let's rely on Backend to assign ID, but we might need temporary ID for UI?
        // Actually, submitOrder returns the saved order with real ID.
        customerName: orderData.customerName,
        customerPhone: orderData.customerPhone,
        customerAddress: orderData.address || '',
        orderType: orderData.orderType,
        location: orderData.location,
        scheduledTime: orderData.scheduledTime,
        notes: orderData.notes,
        subtotal: subtotal,
        deliveryCost: deliveryCost,
        total: subtotal + deliveryCost,
        items: cart
    };
    
    // Call data.js submitOrder (which calls ApiClient)
    try {
        const savedOrder = await submitOrder(orderPayload);
        if (savedOrder) {
            clearCart();
            return savedOrder;
        }
    } catch (e) {
        console.error("Order creation failed", e);
    }
    return null;
}

// تحديث حالة الطلب
async function updateOrderStatus(orderId, newStatus) {
    try {
        // Optimistic update in data.js or just wait?
        // updateOrderStatusData is async in data.js
        await updateOrderStatusData(orderId, newStatus);
        
        // Refresh orders if possible or rely on local update
        // The data.js function usually updates local state too.
        return true;
    } catch (e) {
        return false;
    }
}

// الحصول على طلب بواسطة المعرف
function getOrderById(orderId) {
    const orders = getOrders();
    // Ensure loose comparison because ID might be string or int
    return orders.find(o => o.id == orderId); // loose equality
}

// الحصول على طلب بواسطة رقم الطلب
// Note: Backend might use ID as order number or have separate field. 
// My schema has no 'orderNumber' string field? 
// Schema has `id Int`. 
// I should map `orderNumber` to `id` or assume frontend used `id` as number.
// In existing `data.js` and `orders.js`, `orderNumber` was a string.
// Let's treat `orderNumber` as `id` for now to simplify, or check if I added it.
// I did NOT add orderNumber to schema! 
// FIX: I will use `id` as `orderNumber`.
function getOrderByNumber(orderNumber) {
    const orders = getOrders();
    // orderNumber from session might be string
    return orders.find(o => o.id == orderNumber);
}

// الحصول على طلبات الزبون بواسطة رقم الهاتف
function getCustomerOrders(phone) {
    const orders = getOrders();
    if (!phone) return [];
    if (!orders) return [];
    
    // Normalize phone
    const normalizedPhone = phone.replace(/\s/g, '');
    
    return orders.filter(o => {
        if (!o.customerPhone) return false;
        return o.customerPhone.replace(/\s/g, '') === normalizedPhone;
    });
}

// إلغاء الطلب (حذف تماماً)
async function cancelOrder(orderId) {
    const order = getOrderById(orderId);
    if (!order) return false;

    if (order.status === 'delivered') {
        showToast('لا يمكن حذف طلب تم تسليمه', 'error');
        return false;
    }
    
    if (order.status !== 'new') {
        showToast('لا يمكن حذف الطلب بعد بدء التحضير', 'error');
        return false;
    }
    
    try {
        // Call DELETE endpoint wrapper
        // I need to add deleteOrderData to data.js or call ApiClient directly here?
        // Ideally keep API calls in data.js
        // I added deleteMealData, deleteCategoryData. 
        // I should have added deleteOrderData. I'll add it or direct call.
        // Let's assume I'll call ApiClient here for "No Error" fix or call deleteOrderData if I add it.
        // I'll call ApiClient directly to be safe if I missed updating data.js fully.
        // Better: Use `deleteOrderData` and assume I'll add it to data.js in next step if missing.
        // Actually, I didn't add deleteOrderData. I should just use ApiClient here.
        
        await ApiClient.request(`/orders?id=${orderId}`, { method: 'DELETE' });
        
        // Update local state manually since we bypassed data.js helper
        const orders = getOrders();
        const idx = orders.findIndex(o => o.id == orderId);
        if (idx > -1) orders.splice(idx, 1);
        
        return true;
    } catch (e) {
        showToast('فشل إلغاء الطلب', 'error');
        return false;
    }
}

// تقييم الطلب
async function rateOrder(orderId, rating, review = '') {
    const order = getOrderById(orderId);
    
    if (order && order.status === 'delivered') {
        try {
           await ApiClient.request('/orders', {
               method: 'PUT',
               body: JSON.stringify({ id: orderId, rating, review })
           });
           
           // Update local
           order.rating = rating;
           order.review = review;
           
           showToast('شكراً لتقييمك!', 'success');
           return true;
        } catch (e) {
            console.error(e);
            return false;
        }
    }
    return false;
}

// الحصول على حالة الطلب بالعربية
function getStatusText(status) {
    const statusMap = {
        'new': 'جديد',
        'preparing': 'قيد التحضير',
        'ready': 'جاهز',
        'onTheWay': 'في الطريق',
        'delivered': 'تم التسليم',
        'cancelled': 'ملغي'
    };
    return statusMap[status] || status;
}

// الحصول على لون حالة الطلب
function getStatusColor(status) {
    const colorMap = {
        'new': '#3498db',
        'preparing': '#f39c12',
        'ready': '#9b59b6',
        'onTheWay': '#1abc9c',
        'delivered': '#27ae60',
        'cancelled': '#e74c3c'
    };
    return colorMap[status] || '#95a5a6';
}

// إحصائيات الطلبات
function getOrderStats() {
    const orders = getOrders();
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const todayOrders = orders.filter(o => new Date(o.createdAt) >= today);
    const completedOrders = orders.filter(o => o.status === 'delivered');
    
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    const weekOrders = orders.filter(o => new Date(o.createdAt) >= weekAgo);
    
    const monthAgo = new Date();
    monthAgo.setMonth(monthAgo.getMonth() - 1);
    const monthOrders = orders.filter(o => new Date(o.createdAt) >= monthAgo);
    
    return {
        total: orders.length,
        today: todayOrders.length,
        todayRevenue: todayOrders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0),
        week: weekOrders.length,
        weekRevenue: weekOrders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0),
        month: monthOrders.length,
        monthRevenue: monthOrders.filter(o => o.status === 'delivered').reduce((sum, o) => sum + o.total, 0),
        completed: completedOrders.length,
        totalRevenue: completedOrders.reduce((sum, o) => sum + o.total, 0),
        pending: orders.filter(o => !['delivered', 'cancelled'].includes(o.status)).length,
        onTheWay: orders.filter(o => o.status === 'onTheWay').length
    };
}

// أكثر الوجبات طلباً
// أكثر الوجبات طلباً
function getPopularMeals(period = 'all') {
    let orders = getOrders().filter(o => o.status === 'delivered');
    
    if (period === 'today') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        orders = orders.filter(o => new Date(o.createdAt) >= today);
    }
    
    const mealCounts = {};
    
    orders.forEach(order => {
        order.items.forEach(item => {
            const key = `${item.mealId}-${item.sizeName || 'default'}`;
            if (!mealCounts[key]) {
                mealCounts[key] = {
                    name: item.name,
                    sizeName: item.sizeName,
                    count: 0,
                    revenue: 0
                };
            }
            mealCounts[key].count += item.quantity;
            mealCounts[key].revenue += item.price * item.quantity;
        });
    });
    
    return Object.values(mealCounts)
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);
}
